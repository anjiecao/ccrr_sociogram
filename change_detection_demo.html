<html>
      
    <head>
        <script src= "js/jspsych.js"></script>
        <script src = "js/konva.js"></script>
        <script src="js/English.js"></script>
        
<!-- Or versioned -->
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/choices.js@9.0.1/public/assets/styles/choices.min.css"
/>

<!-- Include Choices JavaScript (latest) -->

<!-- Or versioned -->
<script src="https://cdn.jsdelivr.net/npm/choices.js@9.0.1/public/assets/scripts/choices.min.js"></script>
        <script src="js/jspsych-instructions.js"></script>
        <script src="js/jspsych-drop-down.js"></script>
        <script src="js/country-selector.js"></script>
        <script src = "js/jspsych-change-detection.js"></script>
        <script src = "js/jspsych-survey-text.js"></script>
        <script src ="js/jspsych-html-keyboard-response.js"></script>
        <script src = "js/jspsych-demog-geolocation.js"></script>
        <link rel="stylesheet" href="https://ajax.lug.ustc.edu.cn/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
        <script src="https://ajax.lug.ustc.edu.cn/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
        <script src="https://ajax.lug.ustc.edu.cn/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
        <!-- RMTS Version: <script src="https://code.jquery.com/jquery-1.10.2.js"></script> -->
        <link href="css/jspsych.css" rel="stylesheet" type="text/css"></link>
        <link href="css/style.css" rel="stylesheet" type="text/css"></link>
        <link rel="stylesheet" href="css/w3.css">

        



        
    </head>
    <body></body>
    <script>
   
    var userLang = navigator.language || navigator.userLanguage; 
    var timenum = Date.now();
    var subject_id = 'SS' + timenum;
    jsPsych.data.addProperties({ subject: subject_id });
    jsPsych.data.addProperties({ broswerLang: userLang });

   
    var timeline = [];
        
        
   
      
        
    // creat all the image path 
    var stimulus_pair = 4 
    var stimulus_presentation_length = 1000
    var isi = 500
    var resp_prompt = "Can you describe the differences you saw?"
    
        
    var stimulus_index = Array.from({ length: stimulus_pair }, (v, i) => i+1)
    console.log(stimulus_index)
    var task_stimulus_a = stimulus_index.map(i =>'<img src="images/change_detection/' + i + 'a.jpg" style="width:800px;height:600px;">')
    var task_stimulus_b = stimulus_index.map(i =>'<img src="images/change_detection/' + i + 'b.jpg" style="width:800px;height:600px;">')
    
    // currently might not requires multiple randomization 
    
    var all_change_detection_trials = []
    
    for (i = 0; i < stimulus_pair; i++){
        
        var stimulus_a = task_stimulus_a[i]
        var stimulus_b = task_stimulus_b[i]
        
        var first_stimulus = {
        type: "html-keyboard-response", 
        stimulus: stimulus_a,
        choices:["Space"], 
        //stimulus_duration: 1000, 
        trial_duration: stimulus_presentation_length,
        response_ends_trial: false, 
        }
    
        var second_stimulus = {
            type: "html-keyboard-response", 
            stimulus: stimulus_b,
            choices:["Space"],
            //stimulus_duration: 1000, 
            trial_duration: stimulus_presentation_length,
            response_ends_trial: false 
        }
        
        var second_stimulus_if_node = {
            timeline: [second_stimulus], 
            conditional_function: function(){
                 var data = jsPsych.data.get().last(1).values()[0];
                if(jsPsych.pluginAPI.compareKeys(data.response, 'Space')){
                    return false;
                    } else {
                return true;
                }
                }
        }
        
        var trial_while_loop = {
        timeline: [first_stimulus, second_stimulus_if_node],
        loop_function: function (data) {
            console.log(data.values())
            console.log(data.values()[1])
            var value = data.values()
            if (data.values().length == 2){
                if(data.values()[0].response == jsPsych.pluginAPI.convertKeyCharacterToKeyCode('Space') | 
                  data.values()[1].response == jsPsych.pluginAPI.convertKeyCharacterToKeyCode('Space')){
                    return false
                }else{
                    return true 
                }  
            }else{
                if(data.values()[0].response == jsPsych.pluginAPI.convertKeyCharacterToKeyCode('Space')){
                    return false
                }else{
                    return true 
                }  
                
            }
        }
        }
        
        var survey_trial = {
                type: 'survey-text',
                questions: [
                    {prompt: resp_prompt, name: 'Age'}, 
                ],
            };
        
        all_change_detection_trials.push(trial_while_loop, survey_trial)
        
        
    }
    
    timeline = timeline.concat(all_change_detection_trials)
    console.log("Timeline")
    console.log(timeline)
   
    // this is to hide the second stimulus if the participants already responded to the first 
    
    
    
    
    
    
    
    
    
    //timeline.push(instruction)
     //   timeline.push(dropdown_test)

    //timeline.push(trial_while_loop)
        
      //  timeline.push(dropdown_test)

        
        
    function saveData(name, data){
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '../../../cgi-bin/daffner2000/write_data.php'); // langcog server path
        //xhr.open('POST', 'write_data.php'); // 'write_data.php' is the path to the php file described above.
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.send(JSON.stringify({filename: name, filedata: data}));
    }
        
        
    jsPsych.init({
        timeline: timeline,
        //show_progress_bar: !kid,
        //use_webaudio: true, // this won't work for local testing (CORS), but maybe on server
        //preload_audio: audio,
        //preload_images: images,
        //preload_video: video,
        on_trial_finish: function(){
            saveData("cultureRR1-" + subject_id, jsPsych.data.get().csv());
            jsPsych.data.displayData();
            //setTimeout(function() { turk.submit(jsPsych.data.get().ignore('external-html').json()); }, 5000);
      }
    })
        
        
    </script>
</html>