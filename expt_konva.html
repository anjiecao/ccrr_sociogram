<!DOCTYPE html>
<html>
  <head>
    <script src="https://unpkg.com/konva@7.1.3/konva.min.js"></script>
    <meta charset="utf-8" />
    <title>Konva Responsive Canvas Demo</title>
    <link href="css/jspsych.css" rel="stylesheet" type="text/css"></link>
    <link href="css/style.css" rel="stylesheet" type="text/css"></link>

 <!--<style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: #f0f0f0;
      }
        
      #menu {
        display: none;
        position: absolute;
        width: 60px;
        background-color: white;
        box-shadow: 0 0 5px grey;
        border-radius: 3px;
      }

      #menu button {
        width: 100%;
        background-color: white;
        border: none;
        margin: 0;
        padding: 10px;
      }

      #menu button:hover {
        background-color: lightgray;
      }

      #stage-parent {
        width: 100%;
      }
    </style>-->
  </head>

  <body>
    <div id="stage-parent">
    <div id="container1"></div>
    <div id="menu">
      <div>
        <button id="delete-button">Delete</button>
      </div>
    </div>
    <script>
      // let's think our stage virtual size will be 1000x1000px
      // but the real size will be different to fit user's page
      // so the stage will be 100% visible on any device
        
      //var width = window.innerWidth;
      //var height = window.innerHeight;
   
/*
      var stage = new Konva.Stage({
        container: 'container1',
        width: stageWidth,
        height: stageHeight,
      });

      var layer = new Konva.Layer();
      stage.add(layer);
   */     
        
        var stageWidth = 1000;
        var stageHeight = 1000;
        
        
        var stage = new Konva.Stage({container: 'container1', width: stageWidth, height: stageHeight});
var layer = new Konva.Layer({draggable: false});
stage.add(layer);

// draw a background rect to catch events.
var r1 = new Konva.Rect({x: 0, y: 0, width: stageWidth, height: stageHeight, fill: 'white'})    
layer.add(r1)

// draw a rectangle to be used as the rubber area
var r2 = new Konva.Circle({x: 0, y: 0, radius: 0,stroke: 'red', dash: [2,2]})    
r2.listening(false); // stop r2 catching our mouse events.
layer.add(r2)

stage.draw() // First draw of canvas.
var posStart;
var posNow;
var mode = '';
function startDrag(posIn){
  posStart = {x: posIn.x, y: posIn.y};
  posNow = {x: posIn.x, y: posIn.y};
}

function updateDrag(posIn){ 
  
  // update rubber rect position
  posNow = {x: posIn.x, y: posIn.y};
  var posRect = reverse(posStart,posNow);
  r2.x(posRect.x1);
  r2.y(posRect.y1);
 
  //r2.radius(posRect.x2 - posRect.x1);
  //r2.height(posRect.y2 - posRect.y1);
    
 radius = Math.sqrt(Math.pow((posRect.x2 - posRect.x1), 2) + Math.pow((posRect.y2 - posRect.y1), 2))    

  r2.radius(radius);
    
  r2.visible(true);  
   
  stage.draw(); // redraw any changes.
  
}

// start the rubber drawing on mouse down.
r1.on('mousedown', function(e){ 
  mode = 'drawing';
  startDrag({x: e.evt.layerX, y: e.evt.layerY})
  })

// update the rubber rect on mouse move - note use of 'mode' var to avoid drawing after mouse released.
r1.on('mousemove', function(e){ 
    if (mode === 'drawing'){
      updateDrag({x: e.evt.layerX, y: e.evt.layerY})
    }
})

// here we create the new rect using the location and dimensions of the drawing rect.
r1.on('mouseup', function(e){ 
    mode = '';
    r2.visible(false);
    var newCirc = new Konva.Circle({
      x: r2.x(),
      y: r2.y(),
      radius: r2.radius(),
      fill: 'red',
      listening: true
    })
    layer.add(newCirc);
    stage.draw();
})


// reverse co-ords if user drags left / up
function reverse(r1, r2){
  var r1x = r1.x, r1y = r1.y, r2x = r2.x,  r2y = r2.y, d;
  if (r1x > r2x ){
    d = Math.abs(r1x - r2x);
    r1x = r2x; 
    r2x = r1x + d;
  }
  if (r1y > r2y ){
    d = Math.abs(r1y - r2y);
    r1y = r2y; r2y = r1y + d;
  }
    return ({x1: r1x, y1: r1y, x2: r2x, y2: r2y}); // return the corrected rect.     
}
        
        
     
        
        
        
        
        
    let currentShape;
    console.log(currentShape)
      var menuNode = document.getElementById('menu');
      

      document.getElementById('delete-button').addEventListener('click', () => {
        console.log(currentShape)
        currentShape.destroy();
        layer.draw();
      });
        
        
     

      window.addEventListener('click', () => {
        // hide menu
        menuNode.style.display = 'none';
      });

      stage.on('contextmenu', function (e) {
        // prevent default behavior
        console.log(e.evt.button)
        e.evt.preventDefault();
        if (e.target === stage | e.target === r1) {
          // if we are on empty place of the stage we will do nothing
          return;
        }
        currentShape = e.target;
        console.log(e)
        console.log(currentShape)
        console.log(e.evt.button)
        // show menu
        menuNode.style.display = 'initial';
        var containerRect = stage.container().getBoundingClientRect();
        menuNode.style.top =
          containerRect.top + stage.getPointerPosition().y + 4 + 'px';
        menuNode.style.left =
          containerRect.left + stage.getPointerPosition().x + 4 + 'px';
      });
        
        
    stage.on('click', function (e) {
        // prevent default behavior
        e.evt.preventDefault();
        if (e.evt.button === 2) { //no right clicke
            return;
        }
        
        if (e.target === stage | e.target === r1 ) {
          // if we are on empty place of the stage we will do nothing
          return;
        }
        currentShape = e.target;
        
         var textNode = new Konva.Text({
        text: 'Add Label Here',
        x:  currentShape.attrs.x - currentShape.attrs.radius/2 ,
        y:  currentShape.attrs.y ,
        fontSize: 20,
        fill: "white"
      });

      layer.add(textNode);
      layer.draw();

      textNode.on('dblclick', () => {
        // create textarea over canvas with absolute position

        // first we need to find position for textarea
        // how to find it?

        // at first lets find position of text node relative to the stage:
        var textPosition = textNode.getAbsolutePosition();

        // then lets find position of stage container on the page:
        var stageBox = stage.container().getBoundingClientRect();

        // so position of textarea will be the sum of positions above:
        var areaPosition = {
          x: textPosition.x,
          y: textPosition.y,
        };

        // create textarea and style it
        var textarea = document.createElement('textarea');
        document.body.appendChild(textarea);

        textarea.value = textNode.text();
        textarea.style.position = 'absolute';
        textarea.style.top = areaPosition.y + 'px';
        textarea.style.left = areaPosition.x + 'px';
        textarea.style.width = textNode.width();

        textarea.focus();

        textarea.addEventListener('keydown', function (e) {
          // hide on enter
          if (e.keyCode === 13) {
            textNode.text(textarea.value);
            layer.draw();
            document.body.removeChild(textarea);
          }
        });
      });
          
          
        
        
        
      });

        
    
        
  
    </script>
  </body>
</html>